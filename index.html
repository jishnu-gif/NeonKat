<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Muzik Electro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  <style>
    :root {
      --primary-color: #a88cff;
      --primary-dark: #7a5fff;
    }
    body {
      background: #111111;
      color: #fff;
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: hidden;
    }
    #container {
      width: 100%;
      max-width: 400px;
      background: #111;
      padding: 15px;
      border-radius: 10px;
    }
    h1 {
      font-size: 24px;
      text-align: center;
      margin: 0 0 10px;
      color: #ffffff;
      margin-left: 100px;
    }
    #chooseFolder {
      background: #212121;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      margin-bottom: 10px;
      font-size: 14px;
    }
    #chooseFolder:hover {
      background: var(--primary-color);
    }
    #savePlaylistBtn, #loadPlaylistBtn, #sortBtn {
      background: #212121;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      margin-bottom: 10px;
      font-size: 14px;
    }
    #savePlaylistBtn:hover, #loadPlaylistBtn:hover, #sortBtn:hover {
      background: var(--primary-color);
    }
    #selectedFolderName {
      font-size: 14px;
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 10px;
    }
    #sortMenu {
      position: absolute;
      background: #222;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      z-index: 10;
      display: none;
      width: 150px;
    }
    #sortMenu button {
      background: #212121;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
    }
    #sortMenu button:hover {
      background: var(--primary-color);
    }
    #playlist {
      list-style: none;
      padding: 0;
      margin: 0 0 15px;
      max-height: 170px;
      min-height: 50px;
      overflow-y: auto;
      background: #222;
      border-radius: 5px;
    }
    #playlist li {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 12px;
    }
    #playlist li:last-child {
      border-bottom: none;
    }
    #playlist li:hover {
      background: var(--primary-color);
    }
    #playlist li.active {
      background: #0c0c0c;
      color: #fff;
    }
    #playlist::-webkit-scrollbar {
      width: 8px;
    }
    #playlist::-webkit-scrollbar-track {
      background: #111;
      border-radius: 5px;
    }
    #playlist::-webkit-scrollbar-thumb {
      background: linear-gradient(to bottom, #212121, var(--primary-color));
      border-radius: 5px;
    }
    #playlist::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(to bottom, var(--primary-color), #b19cd9);
    }
    input[type="range"] {
      appearance: none;
      width: 100%;
      height: 5px;
      background: #444;
      border-radius: 5px;
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      position: relative;
      z-index: 2;
    }
    input[type="range"]::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
      flex-wrap: wrap;
    }
    .control-btn.repeat-enabled {
      background: var(--primary-color) !important;
      color: #fff;
    }
    .control-btn.enabled {
      background-color: var(--primary-color) !important;
      color: white !important;
    }
    .control-btn {
      background: #212121;
      color: white;
      border: none;
      padding: 10px 0;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      flex: 1 1 0;
      text-align: center;
      white-space: nowrap;
      height: 38px;
      line-height: 1.2;
    }
    .control-btn:hover {
      background: var(--primary-color);
    }
    #volume {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 100px;
      height: 5px;
      background: #444;
      outline: none;
      border-radius: 5px;
      margin-left: 10px;
    }
    #volume::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
    }
    #volume::-moz-range-thumb {
      -moz-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
    }
    #visualizer {
      width: 100%;
      height: 120px;
      background: #111111;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      border-radius: 5px;
      overflow: hidden;
      box-shadow: inset 0 0 250px #000000bf;
      margin-bottom: 10px;
      position: relative;
      background-size: 100% 100%;
    }
    #progressContainer {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      font-size: 12px;
      color: #ffffff;
    }
    #progressBar {
      flex: 1;
      height: 6px;
      background: #444;
      border-radius: 3px;
      -webkit-appearance: none;
      appearance: none;
    }
    #progressBar::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
    }
    #progressBar::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
    }
    footer {
      text-align: center;
      font-size: 12px;
      color: #ffffff;
      margin-top: 10px;
    }
    .icon {
      width: 20px;
      height: 20px;
      object-fit: contain;
      filter: brightness(0) invert(1);
    }
    #topControls {
      display: flex;
      align-items: center;
      gap: 0px;
      margin-bottom: 1px;
      flex-wrap: nowrap;
    }
    #visualizerControls {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #visualizerColor {
      height: 20px;
      width: 20px;
      padding: 0;
      border: none;
      background: #111111;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="rainbow-helper"></div>
  <div id="container">
    <div id="topControls">
      <button id="notifyToggleBtn" style="background: none; border: none; cursor: pointer;">
        <img src="build/bell.svg" id="bellIcon" height="17" style="filter: invert(40%) sepia(90%) saturate(1200%) hue-rotate(245deg) brightness(570%) contrast(95%);" />
      </button>
      <div id="visualizerControls">
        <button id="visualizerToggleBtn" style="background: none; border: none; cursor: pointer;">
          <img src="build/visualizer.svg" id="visualizerIcon" height="20" style="filter: invert(40%) sepia(90%) saturate(1200%) hue-rotate(245deg) brightness(570%) contrast(95%);" />
        </button>
        <input type="color" id="visualizerColor" value="#a88cff" title="Select Theme Color" />
        <button id="rainbowToggleBtn" style="background: none; border: none; cursor: pointer;">
          <img id="rainbowIcon" src="build/flashoff.svg" height="27" style="filter: invert(40%) sepia(90%) saturate(1200%) hue-rotate(245deg) brightness(570%) contrast(95%);" />
        </button>
      </div>
      <button id="miniplayerToggleBtn" style="background: none; border: none; cursor: pointer; margin-left: 10px;">
        <img src="build/miniplayer.svg" height="20" style="filter: invert(40%) sepia(90%) saturate(1200%) hue-rotate(245deg) brightness(570%) contrast(95%);" />
      </button>
    </div>
    <h1 style="display: flex; align-items: center; gap: 8px;">
      Muzik Electro
      <img src="build/music.gif" style="height: 54px;" />
    </h1>
    <button id="chooseFolder">Choose Folder</button>
    <div style="position: relative;">
      <button id="sortBtn">Sort Playlist</button>
      <div id="sortMenu">
        <button id="sortNameAsc">Name (A-Z)</button>
        <button id="sortNameDesc">Name (Z-A)</button>
        <button id="sortDateDesc">Date (Newest)</button>
        <button id="sortDateAsc">Date (Oldest)</button>
      </div>
    </div>
    <ul id="playlist"></ul>
    <div class="controls" style="display: flex; gap: 10px; margin-bottom: 10px;">
      <button id="playBtn" class="control-btn">
         <img src="build/play.svg" alt="Pause" class="icon" />
      </button>
      <button id="pauseBtn" class="control-btn">
        <img src="build/pause.svg" alt="Pause" class="icon" />
      </button>
      <button id="repeatBtn" class="control-btn">
        <img src="build/repeat.svg" alt="Repeat" class="icon" />
      </button>
      <button id="shuffleBtn" class="control-btn">
        <img src="build/shuffle.svg" alt="Shuffle" class="icon" />
      </button>
    </div>
    <div id="playlistControls" style="display: flex; gap: 10px; margin-bottom: 10px;">
      <button id="savePlaylistBtn" class="control-btn">Save</button>
      <button id="loadPlaylistBtn" class="control-btn">Load</button>
      <button id="clearPlaylistBtn" class="control-btn">Clear</button>
    </div>
    <div class="volume-control" style="display: flex; align-items: center; gap: 5px;">
         <label for="volume">
        <img src="build/volume.svg" alt="Volume" width="20" height="20" > 
        <input type="range" id="volume" min="0" max="1" step="0.01" value="1" />
        <span id="volumePercent">100%</span>
      <div id="selectedFolderName"></div>
    </div>
    <div id="progressContainer">
      <span id="currentTime">0:00</span>
      <input type="range" id="progressBar" value="0" min="0" step="0.1" />
      <span id="duration">0:00</span>
    </div>
    <canvas id="visualizer"></canvas>
    <footer>Made With ♥ By PaleCache</footer>
  </div>
  <audio id="audio"></audio>
  <style>
label img {
  filter: brightness(0) invert(1);
  top: 7px;
  position: relative;
}

</style>
<script>
  const filePickerBtn = document.getElementById('chooseFolder');
  const savePlaylistBtn = document.getElementById('savePlaylistBtn');
  const loadPlaylistBtn = document.getElementById('loadPlaylistBtn');
  const selectedFolderName = document.getElementById('selectedFolderName');
  const playlistElem = document.getElementById('playlist');
  const audio = document.getElementById('audio');
  const visualizerCanvas = document.getElementById('visualizer');
  const ctx = visualizerCanvas.getContext('2d');
  const volumeSlider = document.getElementById('volume');
  const progressBar = document.getElementById('progressBar');
  const currentTimeElem = document.getElementById('currentTime');
  const durationElem = document.getElementById('duration');
  const sortBtn = document.getElementById('sortBtn');
  const sortMenu = document.getElementById('sortMenu');
  let audioFiles = [];
  let currentIndex = 0;
  let isSeeking = false;
  let repeatTrack = false;
  let shuffleTrack = false;
  let notifyEnabled = localStorage.getItem('notifyEnabled') === 'true';
  let visualizerToggle = localStorage.getItem('visualizerToggle') === 'true';
  let animationFrameId = null;
  let themeColor = localStorage.getItem('themeColor') || '#a88cff';
  let isRainbowActive = localStorage.getItem('isRainbowActive') === 'true';
  const rainbowIcon = document.getElementById('rainbowIcon');
  rainbowIcon.src = isRainbowActive ? 'build/flash.svg' : 'build/flashoff.svg';
  const rainbowToggleBtn = document.getElementById('rainbowToggleBtn');
  let rainbowFrameId = null;
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const analyser = audioCtx.createAnalyser();
  analyser.fftSize = 128;
  const source = audioCtx.createMediaElementSource(audio);
  source.connect(analyser);
  analyser.connect(audioCtx.destination);

  const repeatBtn = document.getElementById('repeatBtn');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const visualizerColorPicker = document.getElementById('visualizerColor');
  const miniplayerToggleBtn = document.getElementById('miniplayerToggleBtn');

  function updateSliderBackground(slider) {
    const value = (slider.value - slider.min) / (slider.max - slider.min) * 100;
    slider.style.background = `linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) ${value}%, #444 ${value}%, #444 100%)`;
  }

  function updateThemeColor(color, isRainbow = isRainbowActive) {
    themeColor = color;
    isRainbowActive = isRainbow;
    localStorage.setItem('themeColor', themeColor);
    localStorage.setItem('isRainbowActive', isRainbowActive);

    window.electronAPI.updateTheme({ color, isRainbow });

    if (isRainbowActive) {
      startRainbowColorLoop();
    } else {
      document.documentElement.style.setProperty('--primary-color', themeColor);
      document.documentElement.style.setProperty('--primary-dark', adjustColor(themeColor, -20));
    }

    updateSliderBackground(volumeSlider);
    updateSliderBackground(progressBar);
  }

  visualizerColorPicker.value = themeColor;
  updateThemeColor(themeColor, isRainbowActive);

  visualizerColorPicker.addEventListener('input', (e) => {
    updateThemeColor(e.target.value, false);
  });

  rainbowToggleBtn.addEventListener('click', () => {
    isRainbowActive = !isRainbowActive;
    rainbowIcon.src = isRainbowActive ? 'build/flash.svg' : 'build/flashoff.svg';
    updateThemeColor(themeColor, isRainbowActive);
  });

  miniplayerToggleBtn.addEventListener('click', () => {
    window.electronAPI.toggleMiniplayer();
  });

  shuffleBtn.addEventListener('click', () => {
    shuffleTrack = !shuffleTrack;
    shuffleBtn.classList.toggle('enabled', shuffleTrack);
  });

  repeatBtn.addEventListener('click', () => {
    repeatTrack = !repeatTrack;
    repeatBtn.classList.toggle('enabled', repeatTrack);
  });

  sortBtn.addEventListener('click', () => {
    if (sortMenu.style.display === 'block') {
      sortMenu.style.display = 'none';
    } else {
      sortMenu.style.display = 'block';
    }
  });

  document.getElementById('sortNameAsc').addEventListener('click', () => {
    sortPlaylist('name', true);
    sortMenu.style.display = 'none';
  });

  document.getElementById('sortNameDesc').addEventListener('click', () => {
    sortPlaylist('name', false);
    sortMenu.style.display = 'none';
  });

  document.getElementById('sortDateAsc').addEventListener('click', () => {
    sortPlaylist('date', true);
    sortMenu.style.display = 'none';
  });

  document.getElementById('sortDateDesc').addEventListener('click', () => {
    sortPlaylist('date', false);
    sortMenu.style.display = 'none';
  });

  document.addEventListener('click', (e) => {
    if (!sortBtn.contains(e.target) && !sortMenu.contains(e.target)) {
      sortMenu.style.display = 'none';
    }
  });

  async function sortPlaylist(criteria, ascending) {
    if (audioFiles.length === 0) return 0;

    audioFiles = [...new Set(audioFiles)];
    let sortedFiles = [...audioFiles];

    const currentFile = audioFiles[currentIndex];

    if (criteria === 'name') {
      sortedFiles.sort((a, b) => {
        const nameA = a.split(/[\\/]/).pop().toLowerCase();
        const nameB = b.split(/[\\/]/).pop().toLowerCase();
        return ascending ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
      });
    } else if (criteria === 'date') {
      try {
        const filesWithDates = await Promise.all(
          audioFiles.map(async (file) => {
            try {
              const stats = await window.electronAPI.getFileStats(file);
              const mtimeMs = stats?.mtimeMs ?? 0;
              return { file, date: mtimeMs, name: file.split(/[\\/]/).pop().toLowerCase() };
            } catch {
              return { file, date: 0, name: file.split(/[\\/]/).pop().toLowerCase() };
            }
          })
        );
        filesWithDates.sort((a, b) => {
          const diff = ascending ? a.date - b.date : b.date - a.date;
          if (Math.abs(a.date - b.date) < 1000) {
            return ascending ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
          }
          return diff;
        });
        sortedFiles = filesWithDates.map(item => item.file);
      } catch (err) {
        console.error('Sort failed:', err);
        return 0;
      }
    }

    audioFiles = sortedFiles;
    currentIndex = audioFiles.indexOf(currentFile);
    if (currentIndex === -1) currentIndex = 0;

    renderPlaylist();

    localStorage.setItem('sortCriteria', criteria);
    localStorage.setItem('sortOrder', ascending ? 'asc' : 'desc');
    localStorage.setItem('sortedPlaylist', JSON.stringify(audioFiles));

    return currentIndex;
  }

 
  const sortOptions = sortMenu.querySelectorAll('button');
  sortOptions.forEach(btn => {
    btn.addEventListener('click', () => {
      sortOptions.forEach(b => b.textContent = b.textContent.replace(' ✓', ''));
      btn.textContent += ' ✓';
      selectedSort = btn.id;
      sortMenu.style.display = 'none';
    });
  });

  function updateSortCheckmark(selectedId) {
    sortOptions.forEach(btn => {
      if (btn.id === selectedId) {
        if (!btn.textContent.includes(' ✓')) {
          btn.textContent += ' ✓';
        }
      } else {
        btn.textContent = btn.textContent.replace(' ✓', '');
      }
    });
  }

  playlistElem.addEventListener('dragover', (event) => {
    event.preventDefault();
    playlistElem.style.border = '2px dashed #212121';
  });

  playlistElem.addEventListener('dragleave', (event) => {
    event.preventDefault();
    playlistElem.style.border = '';
  });

  playlistElem.addEventListener('drop', async (event) => {
    event.preventDefault();
    playlistElem.style.border = '';
    const files = Array.from(event.dataTransfer.files);
    const audioExts = ['.mp3', '.wav', '.ogg', '.m4a', '.flac','.opus'];

    const droppedAudioFiles = files.filter(file => {
      const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
      return audioExts.includes(ext);
    });

    if (droppedAudioFiles.length === 0) {
      alert('No supported audio files were dropped.');
      return;
    }

    const newPaths = droppedAudioFiles.map(f => f.path);
    audioFiles = audioFiles.concat(newPaths);
    renderPlaylist();
  });

  const clearPlaylistBtn = document.getElementById('clearPlaylistBtn');

  clearPlaylistBtn.addEventListener('click', () => {
    if (audioFiles.length === 0) return;
    audioFiles = [];
    currentIndex = 0;
    audio.pause();
    audio.src = '';
    visualizerCanvas.style.backgroundImage = 'none';
    visualizerCanvas.style.backgroundColor = '#111111';
    renderPlaylist();
    window.electronAPI.updateTrack({ songName: 'No Track', artUrl: null, isPlaying: false });
  });

  [volumeSlider, progressBar].forEach(slider => {
    updateSliderBackground(slider);
    slider.addEventListener('input', () => updateSliderBackground(slider));
  });

  filePickerBtn.addEventListener('click', async () => {
    try {
      if ('Notification' in window && Notification.permission !== 'granted') {
        await Notification.requestPermission();
      }

      const result = await window.electronAPI.pickFolder();

      if (result) {
        const { folderPath, audioFilePaths } = result;

        if (!audioFilePaths.length) {
          alert('No audio files found!');
          return;
        }

        audioFiles = audioFilePaths;
        currentIndex = 0;

        const sortedIndex = await applySavedSort();
        updateStoredPlaylist();
        renderPlaylist();
        playTrack(0);
        scrollToCurrentTrack();
      } else {
        audioFiles = [];
        renderPlaylist();
        audio.src = '';
        visualizerCanvas.style.backgroundImage = 'none';
        visualizerCanvas.style.backgroundColor = '#111111';
        window.electronAPI.updateTrack({ songName: 'No Track', artUrl: null, isPlaying: false });
      }
    } catch (err) {
      console.error('Folder load error:', err);
      alert('Error: ' + err.message);
    }
  });

  savePlaylistBtn.addEventListener('click', async () => {
    if (audioFiles.length === 0) {
      alert('No tracks to save!');
      return;
    }
    const playlist = audioFiles;
    const success = await window.electronAPI.savePlaylist(playlist);
    alert(success ? 'Playlist saved!' : 'Failed to save playlist');
  });

  loadPlaylistBtn.addEventListener('click', async () => {
    const { canceled, filePaths } = await window.electronAPI.openFile();
    if (canceled || !filePaths.length) return;

    const playlistPath = filePaths[0];
    const ext = playlistPath.split('.').pop().toLowerCase();

    if (ext === 'playlist') {
      const playlistData = await window.electronAPI.readFile(playlistPath);
      audioFiles = JSON.parse(playlistData);
    } else if (ext === 'm3u') {
      audioFiles = await parseM3UFile(playlistPath);
    } else {
      alert('Unsupported playlist format');
      return;
    }

    currentIndex = 0;
    renderPlaylist();
    playTrack(currentIndex);
  });

  const volumePercent = document.getElementById('volumePercent');

  volumeSlider.addEventListener('input', (e) => {
    audio.volume = e.target.value;
    volumePercent.textContent = Math.round(e.target.value * 100) + '%';
    localStorage.setItem('volumeLevel', e.target.value);
    window.electronAPI.updateVolume(e.target.value);
  });

  const savedVolume = localStorage.getItem('volumeLevel');
  if (savedVolume !== null) {
    volumeSlider.value = savedVolume;
    audio.volume = savedVolume;
    volumePercent.textContent = Math.round(savedVolume * 100) + '%';
    updateSliderBackground(volumeSlider);
  } else {
    volumeSlider.value = 1;
    audio.volume = 1;
    volumePercent.textContent = '100%';
    updateSliderBackground(volumeSlider);
  }

  function renderPlaylist() {
    playlistElem.innerHTML = '';
    audioFiles.forEach((filePath, index) => {
      const li = document.createElement('li');
      li.textContent = filePath.split(/[\\/]/).pop();
      li.className = (index === currentIndex) ? 'active' : '';
      li.addEventListener('click', () => {
        currentIndex = index;
        playTrack(currentIndex);
      });
      playlistElem.appendChild(li);
    });

    const active = playlistElem.querySelector('.active');
    if (active) {
      active.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      setTimeout(() => active.scrollIntoView({ behavior: 'auto', block: 'nearest' }), 150);
    }
  }

  async function parseM3UFile(filePath) {
    const content = await window.electronAPI.readFile(filePath);
    const lines = content
      .split(/\r?\n/)
      .map(line => line.trim())
      .filter(line => line && !line.startsWith('#'));

    const pathSeparator = window.navigator.platform.startsWith('Win') ? '\\' : '/';
    const baseDir = filePath.substring(0, filePath.lastIndexOf(pathSeparator));

    const audioPaths = lines.map(line => {
      if (line.startsWith('/') || /^[a-zA-Z]:\\/.test(line)) return line;
      return baseDir + (baseDir.endsWith(pathSeparator) ? '' : pathSeparator) + line;
    });

    return audioPaths;
  }

  async function getAlbumArtUrl(filePath) {
    const defaultImage = 'build/default-artwork.jpg';

    if (!['.mp3', '.m4a', '.flac', '.opus'].some(ext => filePath.toLowerCase().endsWith(ext))) {
      return defaultImage;
    }

    try {
      const buffer = await window.electronAPI.readFileBuffer(filePath);
      const arrayBuffer = buffer.buffer.slice(buffer.byteOffset, buffer.byteOffset + buffer.byteLength);
      const mimeType = filePath.endsWith('.mp3') ? 'audio/mpeg' : filePath.endsWith('.m4a') ? 'audio/mp4' : 'audio/flac';
      const blob = new Blob([arrayBuffer], { type: mimeType });

      return new Promise((resolve) => {
        window.jsmediatags.read(blob, {
          onSuccess: function(tag) {
            const tags = tag.tags;
            if (tags.picture) {
              const picture = tags.picture;
              const uint8Array = new Uint8Array(picture.data);
              let binary = '';
              const chunkSize = 8192;
              for (let i = 0; i < uint8Array.length; i += chunkSize) {
                binary += String.fromCharCode(...uint8Array.subarray(i, i + chunkSize));
              }
              const base64String = btoa(binary);
              resolve(`data:${picture.format};base64,${base64String}`);
            } else {
              resolve(defaultImage);
            }
          },
          onError: function() {
            resolve(defaultImage);
          }
        });
      });
    } catch {
      return defaultImage;
    }
  }

  async function setVisualizerBackground(filePath) {
    const imageUrl = await getAlbumArtUrl(filePath);
    visualizerCanvas.style.backgroundImage = `url(${imageUrl})`;
    visualizerCanvas.style.backgroundColor = '#111111';
  }

  function playTrack(index) {
    if (index < 0 || index >= audioFiles.length) return;
    currentIndex = index;
    const filePath = audioFiles[index];
    audio.src = `file://${filePath}`;
    audio.play();
    setVisualizerBackground(filePath).then(() => {
      const trackData = {
        songName: filePath.split(/[\\/]/).pop(),
        artUrl: visualizerCanvas.style.backgroundImage.slice(5, -2),
        isPlaying: !audio.paused,
        filePath: filePath,
        volume: audio.volume
      };
      window.electronAPI.updateTrack(trackData);
    });
    renderPlaylist();
    progressBar.value = 0;
    progressBar.max = 0;
    currentTimeElem.textContent = '0:00';
    durationElem.textContent = '0:00';

    if (audioCtx.state === 'suspended') audioCtx.resume();
    if (notifyEnabled && Notification.permission === 'granted') {
      const songName = filePath.split(/[\\/]/).pop();
      window.electronAPI.notify('Now Playing', songName);
    }
  }

  document.getElementById('playBtn').addEventListener('click', () => audio.play());
  document.getElementById('pauseBtn').addEventListener('click', () => audio.pause());

  volumeSlider.addEventListener('input', (e) => {
    audio.volume = e.target.value;
  });

  audio.addEventListener('play', () => {
    window.electronAPI.updateTrack({ isPlaying: true, volume: audio.volume });
  });

  audio.addEventListener('pause', () => {
    window.electronAPI.updateTrack({ isPlaying: false, volume: audio.volume });
  });
audio.addEventListener('timeupdate', () => {
  if (!isSeeking && audio.duration) {
    progressBar.max = audio.duration;
    progressBar.value = audio.currentTime;
    currentTimeElem.textContent = formatTime(audio.currentTime);
    durationElem.textContent = formatTime(audio.duration);
    updateSliderBackground(progressBar);
    window.electronAPI.updateTime(audio.currentTime, audio.duration);
  }
});


  progressBar.addEventListener('input', () => {
    isSeeking = true;
  });

  progressBar.addEventListener('change', () => {
    audio.currentTime = parseFloat(progressBar.value);
    isSeeking = false;
    updateSliderBackground(progressBar);
  });

  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  function visualize() {
  if (!visualizerToggle || !analyser) {
    ctx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
    }
    return;
  }

  visualizerCanvas.width = visualizerCanvas.offsetWidth;
  visualizerCanvas.height = visualizerCanvas.offsetHeight;

  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);

  let frameCounter = 0;

  function draw() {
    if (!visualizerToggle || !analyser) {
      ctx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
      return;
    }

    animationFrameId = requestAnimationFrame(draw);

    analyser.getByteFrequencyData(dataArray);

  
    frameCounter++;
    if (frameCounter % 2 === 0) {
      window.electronAPI.updateVisualizer(Array.from(dataArray));
    }

    ctx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
    let songName = audioFiles[currentIndex]?.split(/[\\/]/).pop() || 'No Track';
    if (songName.length > 50) songName = songName.slice(0, 47) + '...';
    ctx.fillStyle = '#FFFFFF';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(songName, visualizerCanvas.width / 2, 18);

    const centerX = visualizerCanvas.width / 2;
    const barWidth = (visualizerCanvas.width / bufferLength) * 1.5;
    const halfCount = Math.floor(bufferLength / 2);
    const currentPrimaryColor = getComputedStyle(document.documentElement)
      .getPropertyValue('--primary-color')
      .trim();

    for (let i = 0; i < halfCount; i++) {
      const scale = 0.5;
      const barHeight = dataArray[i] * (visualizerCanvas.height / 255) * scale;

      const xLeft = centerX - (i + 1) * (barWidth + 1);
      if (xLeft + barWidth > 0) {
        const gradientLeft = ctx.createLinearGradient(xLeft, visualizerCanvas.height - barHeight, xLeft, visualizerCanvas.height);
        gradientLeft.addColorStop(0, currentPrimaryColor);
        gradientLeft.addColorStop(0.5, adjustColor(currentPrimaryColor, -20));
        gradientLeft.addColorStop(1, currentPrimaryColor);
        ctx.fillStyle = gradientLeft;
        ctx.fillRect(xLeft, visualizerCanvas.height - barHeight, barWidth, barHeight);
      }

      const xRight = centerX + i * (barWidth + 1);
      if (xRight < visualizerCanvas.width) {
        const gradientRight = ctx.createLinearGradient(xRight, visualizerCanvas.height - barHeight, xRight, visualizerCanvas.height);
        gradientRight.addColorStop(0, currentPrimaryColor);
        gradientRight.addColorStop(0.5, adjustColor(currentPrimaryColor, -20));
        gradientRight.addColorStop(1, currentPrimaryColor);
        ctx.fillStyle = gradientRight;
        ctx.fillRect(xRight, visualizerCanvas.height - barHeight, barWidth, barHeight);
      }
    }
  }

  draw();
}


  function adjustColor(color, percent) {
    if (color.startsWith('hsl')) {
      const match = color.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
      if (!match) return color;
      let [, hue, saturation, lightness] = match;
      hue = parseInt(hue);
      saturation = parseInt(saturation);
      lightness = parseInt(lightness);
      lightness = Math.min(100, Math.max(0, lightness + percent));
      return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }

    let hex = color.replace('#', '');
    if (hex.length === 3) {
      hex = hex.split('').map(c => c + c).join('');
    }
    if (!/^[0-9a-fA-F]{6}$/.test(hex)) return color;

    let r = parseInt(hex.slice(0, 2), 16);
    let g = parseInt(hex.slice(2, 4), 16);
    let b = parseInt(hex.slice(4, 6), 16);

    r = Math.min(255, Math.max(0, Math.round(r * (1 + percent / 100))));
    g = Math.min(255, Math.max(0, Math.round(g * (1 + percent / 100))));
    b = Math.min(255, Math.max(0, Math.round(b * (1 + percent / 100))));

    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
  }

  const notifyToggleBtn = document.getElementById('notifyToggleBtn');
  const bellIcon = document.getElementById('bellIcon');
  bellIcon.src = notifyEnabled ? 'build/bell-ring.svg' : 'build/bell.svg';

  notifyToggleBtn.addEventListener('click', () => {
    notifyEnabled = !notifyEnabled;
    localStorage.setItem('notifyEnabled', notifyEnabled);
    bellIcon.src = notifyEnabled ? 'build/bell-ring.svg' : 'build/bell.svg';
    if (notifyEnabled && 'Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission().then(permission => {
        if (permission !== 'granted') {
          notifyEnabled = false;
          localStorage.setItem('notifyEnabled', 'false');
          alert('Notifications not enabled in browser.');
        }
      });
    }
  });

  const visualizerToggleBtn = document.getElementById('visualizerToggleBtn');
  const visualizerIcon = document.getElementById('visualizerIcon');
  visualizerIcon.src = visualizerToggle ? 'build/visualizer.svg' : 'build/visualizeroff.svg';

  visualizerToggleBtn.addEventListener('click', () => {
    visualizerToggle = !visualizerToggle;
    localStorage.setItem('visualizerToggle', visualizerToggle);
    visualizerIcon.src = visualizerToggle ? 'build/visualizer.svg' : 'build/visualizeroff.svg';

    if (visualizerToggle) {
      if (!audio.paused) {
        visualize();
      }
      audio.addEventListener('play', visualize);
    } else {
      audio.removeEventListener('play', visualize);
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
                console.log("Disable button clicked in index.html");
        window.electronAPI.disableVisualizer();
      }
      ctx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
    }
  });

  if (visualizerToggle) {
    audio.addEventListener('play', visualize);
  }

  audio.addEventListener('ended', () => {
    if (repeatTrack) {
      playTrack(currentIndex);
    } else if (shuffleTrack) {
      currentIndex = Math.floor(Math.random() * audioFiles.length);
      playTrack(currentIndex);
    } else {
      currentIndex++;
      if (currentIndex >= audioFiles.length) currentIndex = 0;
      playTrack(currentIndex);
    }
  });

  async function applySavedSort() {
    const criteria = localStorage.getItem('sortCriteria');
    const order = localStorage.getItem('sortOrder');

    if (criteria && order) {
      const sortIdMap = {
        'name-asc': 'sortNameAsc',
        'name-desc': 'sortNameDesc',
        'date-asc': 'sortDateAsc',
        'date-desc': 'sortDateDesc'
      };

      const key = `${criteria}-${order}`;
      const buttonId = sortIdMap[key];

      if (buttonId) {
        updateSortCheckmark(buttonId);
      }

      return await sortPlaylist(criteria, order === 'asc');
    }
    return 0;
  }

  function updateStoredPlaylist() {
    try {
      localStorage.setItem('sortedPlaylist', JSON.stringify(audioFiles));
    } catch (e) {
      console.error('Failed to save playlist:', e);
    }
  }

  function scrollToCurrentTrack() {
    const el = document.querySelector(`.track-item[data-index="${currentIndex}"]`);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  let rainbowHue = 0;
function stopVisualizer() {
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
    animationFrameId = null;
  }
  ctx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
  window.electronAPI.disableVisualizer();
}


function startRainbowColorLoop() {
  if (!isRainbowActive || rainbowFrameId) return;

  function updateHue() {
    if (!isRainbowActive) {
      cancelAnimationFrame(rainbowFrameId);
      rainbowFrameId = null;
      return;
    }

    rainbowHue = (rainbowHue + 1) % 360;
    const color = `hsl(${rainbowHue}, 100%, 65%)`;
    const darkColor = `hsl(${rainbowHue}, 100%, 45%)`;

    document.documentElement.style.setProperty('--primary-color', color);
    document.documentElement.style.setProperty('--primary-dark', darkColor);

    updateSliderBackground(volumeSlider);
    updateSliderBackground(progressBar);

    rainbowFrameId = requestAnimationFrame(updateHue);
  }

  rainbowFrameId = requestAnimationFrame(updateHue);
}

function stopRainbowLoop() {
  if (rainbowFrameId) {
    cancelAnimationFrame(rainbowFrameId);
    rainbowFrameId = null;
  }
}

  window.electronAPI.onUpdateTrack((data) => {
    if (data.isPlaying !== undefined) {
      if (data.isPlaying && audio.paused) {
        audio.play();
      } else if (!data.isPlaying && !audio.paused) {
        audio.pause();
      }
    }
  });

  window.electronAPI.onUpdateVolume((volume) => {
    audio.volume = volume;
    volumeSlider.value = volume;
    volumePercent.textContent = Math.round(volume * 100) + '%';
    localStorage.setItem('volumeLevel', volume);
    updateSliderBackground(volumeSlider);
  });

  window.electronAPI.onRequestCurrentState(() => {
    if (audioFiles[currentIndex]) {
      const filePath = audioFiles[currentIndex];
      setVisualizerBackground(filePath).then(() => {
        const trackData = {
          songName: filePath.split(/[\\/]/).pop(),
          artUrl: visualizerCanvas.style.backgroundImage.slice(5, -2),
          isPlaying: !audio.paused,
          filePath: filePath,
          volume: audio.volume
        };
        window.electronAPI.updateTrack(trackData);
      });
      window.electronAPI.updateTheme({ color: themeColor, isRainbow: isRainbowActive });
    }
  });

  window.electronAPI.onPlayPrevious(() => {
    if (currentIndex > 0) {
      currentIndex--;
      playTrack(currentIndex);
    }
  });

  window.electronAPI.onSeekFromMini((time) => {
  if (!isNaN(time) && audio.duration) {
    audio.currentTime = time;    
    progressBar.value = time;    
    currentTimeElem.textContent = formatTime(time);
    updateSliderBackground(progressBar);
  }
})

  window.electronAPI.onPlayNext(() => {
    if (currentIndex < audioFiles.length - 1) {
      currentIndex++;
      playTrack(currentIndex);
    } else if (repeatTrack) {
      currentIndex = 0;
      playTrack(currentIndex);
    }
  });

  window.electronAPI.onTogglePlay(() => {
    if (audio.paused) {
      audio.play();
    } else {
      audio.pause();
    }
  });
</script>
</body>
</html>